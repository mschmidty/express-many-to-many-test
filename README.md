# A Node JS Restful API made with Express, Knex and PostgreSQL
This is a app backend that made to learn Javascript.  I used express, knex and PostgreSQL.  I come from an HTML and CSS background on the web but do most of my work in R for my job as a wildlife biologist. I've long wanted to combine my R work with Databases and my HTML and CSS skills. R ins't approprate for doing backend work, so I figured JS would be a good place to get to know CRUD operations. 

This repo is an Restful API with a many to many relationship. I'm wanted to get better at javascript so I wanted to play around with a SQL style (table based) database to practice manipulating data.  This repo contains my experiments. 

This is a rough todo to track how I did everything. 

## The Master TODO
### Set up
- [x] - use express gerator to generate app with no views. 
- [x] - in `app.js` delete router information auto generated by express generator. 
- [x] - in `app.js` update error handling to return json instead of html. 
- [x] - install knex, pg, and nodemon. 
- [x] - Run Nodemon and make route to '/' to make sure that everything runs. 

### Create Database and Schema
- [x] - Create PostgreSQL database in terminal `createdb man-to-many`
- [x] - Add knex connection to PostgreSQL with `/db/knex.js` file and `knexfile.js`. 
  - [x] - Add `knexfile.js` with connection to database for now we will just have a development connection.
  - [x] - add `/db/knex.js` file with connection details to db. 
- [x] - Make migration `knex migrate:make notes_and_tags` (if knex isn't install run `npm install knex -g`): 
  - [x] - Add schema for Notes, Tags, and NotesTag (join table) tables. 
    - [x] - Notes - id, title and body.
    - [x] - Tags - id and name. 
    - [x] - notesTag will have id, note_id and tag_id
  - [x] - Run Migration `knex migrate:latest`

### Create database POST queries and routes for Many to Many relationship
- [x] - create queries to create note, tag and notestag.
- [x] - create api folder with `notesTags.js` for all router info for notesTag. Bring in router and express. 
- [x] - add notes api routes to app in `app.js`. 
- [x] - make route to create note. 
  - [x] - in note route make query to tags table to add tags. 
  - [x] - get returned note id and returned tag ids and .map to create array of note_id and tag_id to add to notes_tags table. 
  - [x] - add query to tags database to query tags table and see if the tags have already been created.  If they have, return their ids. 
  - [x] - create if else to separate if there are new tags or if there are just old tags. 
    - [x] - if there are old and new tags, take the returned ids from the tags check query, post the new tags, get the responded ids from the post, combine the old and new ids and add to object with note_id and all tag_ids. 
    - [x] - if there are just old tags take the returned ids from the tags check and make object with note_id and all tag_ids. 
    - [x] - post object with node_id and tag_ids to notes_tag table. 

### Create GetOne Route for Many to Many relationship.
- [x] - make `.get` route on `/:id`. 
- [x] - get note based on route param id. 
- [x] - Use note ID to get table with id.  
- [x] - Use joined notes_tag returned fields to return all tags. 

### Update Note Query and Route
- [x] - make `.put` route on `/:id`
- [x] - Use async function.
- [x] - get a `new Date()` to update `updated_at` field, this isn't updated automatically. 
- [x] - update the note based on param.id and request (title, body, updated_at).
- [x] - use response to get joining table based on `note_id`.
- [x] - get tags using `tag_id` from joining table.
- [x] - compare tags that have been requested to the tags in the DB.  
- [x] - create list of tags to delete from joining table.
- [x] - create list of tags to add to `tags` table and to add to joining table. 
- [x] - combine the delete list with add list to output with response. 
- [x] - if there are tags to delete delete the tag entry from joining table (do not delete from `tags` table because the tag might be used for another note)
- [x] - if there are tags that are not yet in the database add those tags and return them so that they can be added to the joining table with the `note_id`.
- [x] - get the tags for the note with a new knex query.  I made a function to do this from the createNote function so I didn't have to write the code out again.  The function `getTagsForNote()` just needs to be passed a note ID and it will return all the tags for that note. 
- [x] - return the updated note, new list of tags from `getTagsForNote` and the `tagTodo` which kept track of what notes were added and removed. 

### Get All Notes and Tags
- [x] - Make route on `/` to get all notes. 
- [x] - Make async query function.
- [x] - get all notes.
- [x] - use response to get tags for each note.id. 
  - [x] - use map to loop over array of notes. If map is inside of an async function, the map function must be an async function inside `Promise.all()`.  
  - [x] - for each note get tags using joining table. 
  - [x] - return note and tags for each note. 
- [x] - return note and tags from `Promise.all(...map...)` function.

### Delete Note query and route
- [x] - create `delete` route on `/:id`. 
- [x] - delete note based on ID.
- [x] - delete joining table entries based on note ID. Don't delete actual tags. 

